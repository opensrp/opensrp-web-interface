CREATE OR REPLACE FUNCTION core.committed_previous_action (lists varchar[]) 
RETURNS int
AS $$
    DECLARE json_object json;
    DECLARE item json;
    DECLARE i varchar; 
    DECLARE totalCount int:=0; 
    DECLARE childs RECORD;
    DECLARE val varchar = '';
    DECLARE returnVal varchar = 'Yes';
    DECLARE temprow RECORD;
    DECLARE totalSize int;
    BEGIN   
       FOR childs IN 
           SELECT c.base_entity_id as baseEntityId,c.birth_date as dob FROM core."viewJsonDataConversionOfClient" c  
            WHERE c.event_type ='Birth Registration' 
            -- and base_entity_id ='a159347c-081c-4dce-ab2b-4324aa21f75f' 
             and provider_id='joom'
          
        LOOP 
        	val = '';
            FOR temprow IN 
                SELECT * FROM core.event e  
                WHERE e.json->>'eventType' ='Lactating Woman Counselling' 
                and cast(e.json->>'baseEntityId' as varchar) = childs.baseEntityId       
                LOOP
                	
                    FOR item IN SELECT * FROM json_array_elements((temprow.json->>'obs')::json)
                    LOOP
                        IF (item->>'formSubmissionField') = 'lactating_counselling_actions_decided_previous_meeting' 
                        THEN
                        val = (item->>'values')::json->>0;                
                        END IF;
                    END LOOP;
                    IF val = 'No' 
                        THEN                    
                        EXIT;               
                    END IF;
            END LOOP;
            IF val='Yes'
                THEN 
                totalCount= totalCount+1;
             END IF;
        END LOOP; 
    return  totalCount; 
   	
  END;
  $$ LANGUAGE 'plpgsql';
  
select core.committed_previous_action (array['a9ab3f4d-bee9-4ba9-8951-119ccd215ab9']);