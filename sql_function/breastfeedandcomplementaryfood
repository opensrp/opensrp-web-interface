CREATE OR REPLACE FUNCTION core.breastfeed_and_complementary_foods (conditions varchar,startDate varchar,endDate varchar) 
RETURNS int
AS $$
    DECLARE json_object json;
    DECLARE item json;
    DECLARE breastFeeding varchar = '';
    DECLARE complementaryFood varchar = '';
    DECLARE breastFeedAndcomplementaryFood int = 2;
    DECLARE childs RECORD;
    DECLARE temprow RECORD;
    DECLARE totalCount int:= 0; 
     betweenCondition varchar := '';
    BEGIN  
    if (startDate != '' AND endDate != '') THEN            
		betweenCondition := betweenCondition || E' and( cg.last_event_date between \''|| startDate || E'\' and \''
                             || endDate || E'\')';
        END IF;
    	FOR childs IN
             EXECUTE 'SELECT c.base_entity_id as baseEntityId,c.birth_date as dob FROM core."viewJsonDataConversionOfClient" as c  
            WHERE c.event_type =' || E' \'Birth Registration\' '|| conditions
           --  and provider_id='joom'
           -- and base_entity_id ='7d8782d9-ded5-4d57-beab-b9f1b5ef1e73'
            LOOP	
            breastFeedAndcomplementaryFood  = 0;
            FOR temprow IN 
                SELECT * FROM core.event e  
                WHERE e.json->>'eventType' ='Lactating Woman Counselling' 
                and cast(e.json->>'baseEntityId' as varchar) =  childs.baseEntityId and 
                (DATE_PART('day', cast(e.json->>'eventDate' as varchar)::timestamp - childs.dob::timestamp  )>181
                 and DATE_PART('day', cast(e.json->>'eventDate' as varchar)::timestamp - childs.dob::timestamp  ) <271)
				
                LOOP
                	
                    FOR item IN SELECT * FROM json_array_elements((temprow.json->>'obs')::json)
                    LOOP
                        IF (item->>'formSubmissionField') = 'breastfeeding' 
                        THEN
                        breastfeeding = (item->>'values')::json->>0;                
                        END IF;
                        IF (item->>'formSubmissionField') = 'complimentary_amount' 
                        THEN
                        complementaryFood = (item->>'values')::json->>0;                
                        END IF;
                    END LOOP;
                    IF breastfeeding = 'No'  OR complementaryFood ='0'
                        THEN
                        breastFeedAndcomplementaryFood = 1;
                        Exit  ;              
                    END IF;
               END LOOP;
               		IF breastFeedAndcomplementaryFood = 0
                    	THEN 
                        totalCount = totalCount+1;
                       --RAISE NOTICE 'i want to print % ', breastFeedAndcomplementaryFood;
                 	END IF;
   			END LOOP;
    return totalCount;
  END;
  $$ LANGUAGE 'plpgsql';
  
